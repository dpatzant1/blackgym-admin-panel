# Documentaci√≥n Backend para Desarrollo Frontend - Black Gym Panel de Administraci√≥n

## üìã Informaci√≥n General

**Servidor Backend**: Node.js + Express  
**Base de Datos**: Supabase (PostgreSQL)  
**Puerto**: `3000` (http://localhost:3000)  
**CORS Configurado**: Puertos `3001` (React) y `4321` (Astro)  y `5173` (Vite)
**Estado**: ‚úÖ Completamente funcional y testeado  

---

## üîê Sistema de Autenticaci√≥n

### **M√©todo de Autenticaci√≥n**
- **Tipo**: Headers personalizados (sin tokens, sin sesiones)
- **Headers requeridos**:
  ```
  x-admin-user: nombre_usuario
  x-admin-password: contrase√±a_en_texto_plano
  ```
- **Verificaci√≥n**: En tiempo real con bcrypt
- **Sin estado**: No se mantienen sesiones en el servidor

### **Credenciales de Prueba**
```
Usuario: admin
Contrase√±a: Admin123!
```

### **Flujo de Autenticaci√≥n Frontend**
1. **Login inicial**: Usuario ingresa credenciales ‚Üí Verificar con `POST /api/administradores/verify`
2. **Almacenamiento**: Guardar credenciales en localStorage tras verificaci√≥n exitosa
3. **Peticiones administrativas**: Incluir headers `x-admin-user` y `x-admin-password` en cada request
4. **Manejo de errores**: 401/403 ‚Üí Redirigir a login

---

## üìö Endpoints Disponibles

### **üè† Informaci√≥n General**

#### `GET /`
Informaci√≥n general del servidor
```json
{
  "success": true,
  "message": "Bienvenido al API de Black Gym - Tienda Online con Panel de Administraci√≥n",
  "version": "1.0.0",
  "authentication": {
    "method": "Headers personalizados (sin tokens/sesiones)",
    "headers": ["x-admin-user", "x-admin-password"]
  }
}
```

#### `GET /health`
Estado del servidor y conexi√≥n a base de datos
```json
{
  "success": true,
  "data": {
    "status": "ok",
    "database": { "connected": true },
    "uptime": 3600
  }
}
```

#### `GET /api`
Documentaci√≥n completa de todos los endpoints disponibles

---

### **üë®‚Äçüíº Autenticaci√≥n de Administradores**

#### `POST /api/administradores/verify`
**Funci√≥n**: Verificar credenciales de administrador  
**Autenticaci√≥n**: No requerida (endpoint p√∫blico)  
**Body**:
```json
{
  "usuario": "admin",
  "password": "Admin123!"
}
```
**Respuesta exitosa**:
```json
{
  "success": true,
  "data": {
    "admin": {
      "id": 1,
      "usuario": "admin",
      "creado_en": "2025-09-11T03:39:48.468956"
    },
    "authenticated": true
  },
  "message": "Credenciales v√°lidas"
}
```

#### `GET /api/administradores/profile` üîí
**Funci√≥n**: Obtener perfil del administrador autenticado  
**Autenticaci√≥n**: Requerida  
**Headers**:
```
x-admin-user: admin
x-admin-password: Admin123!
```
**Respuesta**:
```json
{
  "success": true,
  "data": {
    "admin": {
      "id": 1,
      "usuario": "admin",
      "creado_en": "2025-09-11T03:39:48.468956"
    }
  },
  "message": "Perfil obtenido correctamente"
}
```

#### `PUT /api/administradores/change-password` üîí
**Funci√≥n**: Cambiar contrase√±a del administrador  
**Autenticaci√≥n**: Requerida  
**Body**:
```json
{
  "passwordActual": "Admin123!",
  "passwordNuevo": "NuevoPassword123!"
}
```

---

### **üì¶ Gesti√≥n de Productos**

#### `GET /api/productos`
**Funci√≥n**: Listar productos con paginaci√≥n y filtros  
**Autenticaci√≥n**: No requerida (p√∫blico)  
**Query Parameters**:
- `page`: P√°gina (default: 1)
- `limit`: Elementos por p√°gina (default: 10, max: 100)
- `categoria`: Filtrar por ID de categor√≠a
- `disponible`: true/false
- `search`: B√∫squeda en nombre y descripci√≥n

**Ejemplo**: `GET /api/productos?page=1&limit=20&categoria=1&disponible=true`

#### `GET /api/productos/search`
**Funci√≥n**: B√∫squeda avanzada de productos  
**Query Parameters**: `q` (t√©rmino de b√∫squeda)

#### `GET /api/productos/:id`
**Funci√≥n**: Obtener producto espec√≠fico por ID

#### `POST /api/productos` üîí
**Funci√≥n**: Crear nuevo producto  
**Autenticaci√≥n**: Requerida  
**Body**:
```json
{
  "nombre": "Prote√≠na Whey",
  "descripcion": "Prote√≠na de alta calidad",
  "precio": 29.99,
  "stock": 100,
  "imagen_url": "https://example.com/imagen.jpg",
  "disponible": true,
  "categorias": [1, 2]
}
```

#### `PUT /api/productos/:id` üîí
**Funci√≥n**: Actualizar producto completo  
**Autenticaci√≥n**: Requerida

#### `PATCH /api/productos/:id/stock` üîí
**Funci√≥n**: Actualizar solo el stock  
**Autenticaci√≥n**: Requerida  
**Body**:
```json
{
  "stock": 50
}
```

#### `DELETE /api/productos/:id` üîí
**Funci√≥n**: Eliminar producto  
**Autenticaci√≥n**: Requerida

#### `POST /api/productos/check-stock`
**Funci√≥n**: Verificar stock de m√∫ltiples productos  
**Body**:
```json
{
  "productos": [
    { "id": 1, "cantidad": 2 },
    { "id": 2, "cantidad": 1 }
  ]
}
```

---

### **üè∑Ô∏è Gesti√≥n de Categor√≠as**

#### `GET /api/categorias`
**Funci√≥n**: Listar categor√≠as  
**Query Parameters**: `page`, `limit`, `include_products`

#### `GET /api/categorias/:id`
**Funci√≥n**: Obtener categor√≠a espec√≠fica

#### `POST /api/categorias` üîí
**Funci√≥n**: Crear nueva categor√≠a  
**Autenticaci√≥n**: Requerida  
**Body**:
```json
{
  "nombre": "Suplementos",
  "descripcion": "Productos nutritivos",
  "imagen_url": "https://example.com/categoria.jpg"
}
```

#### `PUT /api/categorias/:id` üîí
**Funci√≥n**: Actualizar categor√≠a  
**Autenticaci√≥n**: Requerida

#### `DELETE /api/categorias/:id` üîí
**Funci√≥n**: Eliminar categor√≠a  
**Autenticaci√≥n**: Requerida

#### `GET /api/categorias/:id/productos`
**Funci√≥n**: Obtener productos de una categor√≠a

#### `POST /api/categorias/productos/:id/assign` üîí
**Funci√≥n**: Asignar categor√≠as a un producto  
**Autenticaci√≥n**: Requerida  
**Body**:
```json
{
  "categorias": [1, 2, 3]
}
```

---

### **üõí Gesti√≥n de √ìrdenes**

#### `GET /api/ordenes`
**Funci√≥n**: Listar √≥rdenes  
**Query Parameters**: `page`, `limit`, `estado`, `include_details`

#### `GET /api/ordenes/stats` üîí
**Funci√≥n**: Estad√≠sticas de √≥rdenes (solo admins)  
**Autenticaci√≥n**: Requerida

#### `GET /api/ordenes/:id`
**Funci√≥n**: Obtener orden espec√≠fica

#### `POST /api/ordenes`
**Funci√≥n**: Crear nueva orden  
**Body**:
```json
{
  "cliente_nombre": "Juan P√©rez",
  "cliente_email": "juan@email.com",
  "cliente_telefono": "12345678",
  "cliente_direccion": "Direcci√≥n completa",
  "productos": [
    {
      "producto_id": 1,
      "cantidad": 2,
      "precio_unitario": 29.99
    }
  ]
}
```

#### `PUT /api/ordenes/:id` üîí
**Funci√≥n**: Actualizar orden  
**Autenticaci√≥n**: Requerida

#### `DELETE /api/ordenes/:id` üîí
**Funci√≥n**: Cancelar orden (restaura stock)  
**Autenticaci√≥n**: Requerida

#### `GET /api/ordenes/:id/detalle`
**Funci√≥n**: Detalle completo de orden con productos

---

### **üì∏ Subida de Im√°genes**

#### `POST /api/uploads/image` üîí
**Funci√≥n**: Subir imagen a Supabase Storage  
**Autenticaci√≥n**: Requerida  
**Content-Type**: `multipart/form-data`  
**Field**: `image` (archivo)

**Restricciones**:
- **Tama√±o m√°ximo**: 5MB
- **Tipos permitidos**: `image/jpeg`, `image/png`, `image/webp`
- **Validaci√≥n**: Autom√°tica de tipo MIME y extensi√≥n

**Ejemplo con FormData (JavaScript)**:
```javascript
const formData = new FormData();
formData.append('image', file);

fetch('/api/uploads/image', {
  method: 'POST',
  headers: {
    'x-admin-user': 'admin',
    'x-admin-password': 'Admin123!'
  },
  body: formData
});
```

**Respuesta exitosa**:
```json
{
  "success": true,
  "data": {
    "url": "https://supabase-storage-url/imagen.jpg",
    "fileName": "imagen_1694432123.jpg",
    "size": 1024000
  },
  "message": "Imagen subida correctamente"
}
```

---

## üö´ Manejo de Errores

### **C√≥digos de Error Comunes**
- **400**: Datos inv√°lidos o faltantes
- **401**: Headers de autenticaci√≥n faltantes
- **403**: Credenciales inv√°lidas
- **404**: Recurso no encontrado
- **413**: Archivo muy grande (>5MB)
- **415**: Tipo de archivo no permitido
- **500**: Error interno del servidor

### **Estructura de Respuesta de Error**
```json
{
  "success": false,
  "error": "Descripci√≥n del error",
  "details": ["Detalle espec√≠fico 1", "Detalle espec√≠fico 2"]
}
```

### **Errores de Autenticaci√≥n**
```json
{
  "success": false,
  "error": "Headers de autenticaci√≥n requeridos",
  "details": null
}
```

```json
{
  "success": false,
  "error": "Credenciales inv√°lidas",
  "details": null
}
```

---

## üé® Consideraciones para el Frontend

### **Estado de Autenticaci√≥n**
```javascript
// Verificar credenciales al inicio
const verificarCredenciales = async () => {
  const usuario = localStorage.getItem('admin-user');
  const password = localStorage.getItem('admin-password');
  
  if (!usuario || !password) {
    // Redirigir a login
    return false;
  }
  
  try {
    const response = await fetch('/api/administradores/verify', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ usuario, password })
    });
    
    const data = await response.json();
    return data.success;
  } catch (error) {
    return false;
  }
};
```

### **Headers de Autenticaci√≥n**
```javascript
// Funci√≥n helper para incluir headers
const getAuthHeaders = () => ({
  'Content-Type': 'application/json',
  'x-admin-user': localStorage.getItem('admin-user'),
  'x-admin-password': localStorage.getItem('admin-password')
});

// Uso en requests
fetch('/api/productos', {
  method: 'POST',
  headers: getAuthHeaders(),
  body: JSON.stringify(productoData)
});
```

### **Upload de Im√°genes**
```javascript
const subirImagen = async (file) => {
  const formData = new FormData();
  formData.append('image', file);
  
  const response = await fetch('/api/uploads/image', {
    method: 'POST',
    headers: {
      'x-admin-user': localStorage.getItem('admin-user'),
      'x-admin-password': localStorage.getItem('admin-password')
      // NO incluir Content-Type para FormData
    },
    body: formData
  });
  
  return response.json();
};
```

### **Paginaci√≥n**
```javascript
// Manejar respuestas paginadas
const cargarProductos = async (page = 1, limit = 20) => {
  const response = await fetch(`/api/productos?page=${page}&limit=${limit}`);
  const data = await response.json();
  
  return {
    productos: data.data.productos,
    pagination: data.data.pagination
  };
};
```

---

## üìã Funcionalidades Sugeridas para el Panel

### **Dashboard Principal**
- Estad√≠sticas generales (`GET /api/ordenes/stats`)
- Productos con stock bajo
- √ìrdenes recientes
- Resumen de ventas

### **Gesti√≥n de Productos**
- Lista con paginaci√≥n y filtros
- Formulario crear/editar producto
- Upload de im√°genes con preview
- Gesti√≥n de stock
- Asignaci√≥n de categor√≠as

### **Gesti√≥n de Categor√≠as**
- CRUD completo de categor√≠as
- Vista de productos por categor√≠a
- Upload de imagen de categor√≠a

### **Gesti√≥n de √ìrdenes**
- Lista de √≥rdenes con filtros por estado
- Detalle de orden con productos
- Cambio de estado de √≥rdenes
- Cancelaci√≥n de √≥rdenes

### **Upload de Im√°genes**
- Drag & drop interface
- Preview antes de subir
- Validaci√≥n de tama√±o y tipo
- Cropping opcional
- Galer√≠a de im√°genes subidas

### **Autenticaci√≥n**
- Login con validaci√≥n
- Cambio de contrase√±a
- Logout (limpiar localStorage)
- Protecci√≥n de rutas

---

## üîß Variables de Entorno Requeridas

```env
# Supabase
SUPABASE_URL=tu_supabase_url
SUPABASE_ANON_KEY=tu_anon_key

# Servidor
PORT=3000
NODE_ENV=development

# CORS
CORS_ORIGIN=http://localhost:4321,http://localhost:3001,http://localhost:5173
```

---

## üöÄ Para Iniciar el Backend

```bash
# Instalar dependencias
npm install

# Iniciar servidor
npm start

# El servidor estar√° disponible en http://localhost:3000
```

---

## ‚úÖ Estado Actual del Backend

- ‚úÖ **Sistema de autenticaci√≥n completo**
- ‚úÖ **CRUD de productos con categor√≠as**
- ‚úÖ **Sistema de √≥rdenes con transacciones**
- ‚úÖ **Upload de im√°genes a Supabase Storage**
- ‚úÖ **Middleware de protecci√≥n implementado**
- ‚úÖ **Validaciones y manejo de errores**
- ‚úÖ **CORS configurado para frontend**
- ‚úÖ **Documentaci√≥n de API completa**
- ‚úÖ **Testeado y funcionando correctamente**

**El backend est√° 100% listo para el desarrollo del frontend del panel de administraci√≥n.**